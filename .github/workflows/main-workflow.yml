name: Main workflow
on: push 
jobs:

  step1:
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      matrix: ${{ steps.matrix_setup.outputs.value }}    
    steps:
    - name: Setup
      id: matrix_setup
      run: echo "value=$(jq -r -c . <<< '${{vars.TENANT_DETAILS}}')" >> $GITHUB_OUTPUT

  step2:
    needs: [step1]
    runs-on: ubuntu-latest
    strategy:
      matrix: 
        include: ${{ fromJSON(needs.step1.outputs.matrix) }}

    steps:
    - name: Check
      env:
        MATRIX: ${{ toJSON(matrix) }}
        APP_NAME: ${{ join(fromJSON(toJSON(matrix)).tenant_details.*.app-name, ', ') }}
        PUBLISH_PROFILE: ${{ join(fromJSON(toJSON(matrix)).tenant_details.*.publish-profile, ', ') }}   
        PUBLISH_PROFILE_SECRET: ${{ secrets[format('{0}' , '$PUBLISH_PROFILE')] }}     
      run: |
        echo "MATRIX: $MATRIX"
        echo "APPNAME: $APP_NAME"
        echo "PUBLISH PROFILE NAME: $PUBLISH_PROFILE"

    - name: step-3
      uses: Nidhi-Patel20/Git-Practice/.github/workflows/format-secret.yml@main
      with:
        environment: staging
        PUBLISH_PROFILE_SECRET: $PUBLISH_PROFILE_SECRET
        # PUBLISH_PROFILE_SECRET_2: ${{ secrets[format('{0}' , 'PUBLISH_PROFILE_2')] }}
    
  # Secret_format_job:
  #   needs: [step2]
  #   uses: Nidhi-Patel20/Git-Practice/.github/workflows/format-secret.yml@main
  #   with:
  #     environment: staging
  #   secrets:
  #     PUBLISH_PROFILE_SECRET: ${{ secrets[format('{0}' , '$PUBLISH_PROFILE')] }}
      # PUBLISH_PROFILE_SECRET_2: ${{ secrets[format('{0}' , 'PUBLISH_PROFILE_2')] }}





          

      